# SupplySleuth

- это комплексное решение для автоматизации скачивания, анализа и уведомления о государственных закупках через площадку ЕИС. Проект использует FTP для получения данных в формате XML, обрабатывает их для извлечения необходимой информации, структурирует данные и переводит их в базу данных PostgreSQL. Это позволяет пользователям проводить глубокий анализ закупок по различным параметрам, включая заказчика, подрядчика, проектировщика и регион. Система уведомлений информирует пользователей о новых торгах по электронной почте или через телеграм-канал и предоставляет возможность поиска торгов по ключевым фразам в документации.

## Особенности

- Автоматическое скачивание данных с площадки ЕИС через FTP.
- Обработка и структурирование данных из XML-разметки.
- Интеграция с базой данных PostgreSQL для хранения и анализа данных.
- Расширенный поиск и анализ закупок по множеству параметров.
- Система уведомлений о новых закупках через электронную почту и телеграм.
- Поиск по фразам в документации торгов.

## Начало работы

Для начала работы с TenderStreamline следуйте инструкциям ниже.

Данные инструкции помогут вам получить копию проекта и запустить его на локальной машине для разработки и тестирования.


### Предварительные требования

Перед установкой убедитесь, что у вас установлены следующие инструменты:
- Python 3.8+
- PostgreSQL
- FTP клиент
- 
```TODO--> необходимо доработать этот раздел позже```

### Установка
1. Клонируйте репозиторий с GitHub:
```bash
git clone <url_репозитория>
 ```
   
2. Установите зависимости:

Для работы с проектом вам понадобится установить необходимые зависимости. Сделать это можно следующим образом:


3. Установите необходимые зависимости, используя `pip` и файл `requirements.txt`, который находится в корне проекта:
    ```bash
    pip install -r requirements.txt
    ```
Это установит все необходимые библиотеки, указанные в файле requirements.txt, включая:

- loguru == 0.7.2
- requests == 2.31.0
- beautifulsoup4 == 4.12.2
- tqdm == 4.66.2
- python-dotenv == 1.0.1
- psycopg2 == 2.9.9

Теперь вы готовы к использованию проекта!

## Использование

1. Описание и использование параметров для настройки программы:

## Модули

### config_requests_ftp_44_fz.py:
Модуль для хранения настроек подключения к FTP серверу.
### directories.json:
JSON-файл, содержащий пути к директориям на FTP сервере.
### ftp_request_44_fz.py:
Модуль для скачивания файлов с FTP сервера.
Подробное описание модулей
## Модуль:
### config_requests_ftp_44_fz.py
Этот модуль управляет настройками подключения к FTP серверу.
#### Классы
##### FTPClientSettings:
Класс для хранения настроек подключения к FTP серверу.

###### Методы
**get_config_value_ftp_settings(key)**

Описание: Возвращает значение конфигурационной переменной по ключу.

**Параметры:**
- key (str): Имя конфигурационной переменной.

**Возвращаемое значение:** 
- Значение переменной, если она существует, иначе None.

**Пример использования:**

```Python
host = FTPClientSettings.get_config_value_ftp_settings('host')
```
**get_json_file_path()**

Описание: Получает путь к JSON-файлу.
**Возвращаемое значение:** str — Путь к JSON-файлу.
**Пример использования:**
```
json_path = FTPClientSettings.get_json_file_path()
```

## Модуль:
### ftp_request_44_fz.py:
Этот модуль отвечает за скачивание файлов с FTP сервера.

#### Классы
##### FTPDownloader:
Класс для скачивания файлов с FTP сервера.

###### Методы
**__init__()**

Описание: Инициализирует объект класса FTPDownloader.connect()

**Описание:** Устанавливает соединение с FTP сервером.

**Исключения:** Логирует ошибку при подключении.
**Пример использования:**
```
downloader = FTPDownloader()
downloader.connect()
```
**close_connection()**

**Описание:** Закрывает соединение с FTP сервером.

**Пример использования:**
```
downloader.close_connection()
```
**download_files_from_directory(directory)**

**Описание:** Скачивает файлы из указанной директории на FTP сервере.

**Параметры:**
- directory (str): Путь к директории на FTP сервере.

**Возвращаемое значение:** 
- List[str] — Список путей к скачанным файлам.

**Исключения:** 
- Логирует ошибку при загрузке файлов.

**Пример использования:**
```
files = downloader.download_files_from_directory('/some/directory')
```
**download_files()**

**Описание:** Скачивает файлы из всех директорий, указанных в JSON-файле.

**Возвращаемое значение:** 
- List[str] — Список всех скачанных файлов.

**Пример использования:**
```python

all_files = downloader.download_files()
```

**is_valid_date(filename, date)**

**Описание:** Проверяет, соответствует ли дата в имени файла заданной дате.

**Параметры:**
- filename (str): Имя файла.
- date (str): Дата для сравнения.

**Возвращаемое значение:** 
- bool — True, если дата в имени файла больше заданной, иначе False.

**Пример использования:**
```
valid = downloader.is_valid_date('file_20230101.xml', '20230100')
```

**download_single_file(filename, file_path)**

**Описание:** Скачивает отдельный файл с FTP сервера.

**Параметры:**
- filename (str): Имя файла для скачивания.
- file_path (str): Путь к файлу на FTP сервере.

**Исключения:** Логирует информацию о скачивании и ошибках.

**Пример использования:**
```
downloader.download_single_file('example.xml.zip', '/path/to/example.xml.zip')
```

**delete_downloaded_file(file_path)**

**Описание:** Удаляет скачанный файл из локальной директории.

**Параметры:**
- file_path (str): Путь к локальному файлу.
- 
**Исключения:** Логирует ошибку при удалении файла.

**Пример использования:**
```
downloader.delete_downloaded_file('/local/path/to/file.xml.zip')
```
**load_paths_from_json()**

**Описание:** Загружает пути к директориям из JSON-файла.

**Возвращаемое значение:**
- List[str] — Список директорий.
**Исключения:** Логирует ошибку при открытии файла.
- 
**Пример использования:**
```
directories = downloader.load_paths_from_json()
```

## Модуль: 
### directories.json

Этот файл содержит пути к директориям на FTP сервере, из которых будут скачиваться файлы.

**Пример содержимого:**
```json
{
    "0": "/fcs_regions/Adygeja_Resp/notifications/currMonth",
    "1": "/fcs_regions/Altaj_Resp/notifications/currMonth",
    "2": "/fcs_regions/Altajskij_kraj/notifications/currMonth",
    "3": "/fcs_regions/Amurskaja_obl/notifications/currMonth",
    "4": "/fcs_regions/Arkhangelskaja_obl/notifications/currMonth",
    "5": "/fcs_regions/Astrakhanskaja_obl/notifications/currMonth"
}
```

## Модуль 
### DatabaseManager
Модуль DatabaseManager предоставляет функциональность для управления подключением и операциями
с базой данных PostgreSQL.
Он использует библиотеку psycopg2 для взаимодействия с базой данных и библиотеку loguru
для ведения логов.
Модуль также загружает переменные окружения из файла .env для безопасного хранения учетных данных.

#### Класс

##### DatabaseManager:

Класс DatabaseManager предназначен для выполнения операций с базой данных,
включая подключение к базе данных, проверку существования файлов,
вставку данных и получение информации о контрактах.

**Атрибуты:**

- connection (psycopg2.extensions.connection): Объект соединения с базой данных.

- cursor (psycopg2.extensions.cursor): Объект курсора для выполнения операций с базой данных.

###### Методы:

**__init__()**

**Описание:**
Инициализация объекта DatabaseManager.

Этот метод подключается к базе данных и инициализирует курсор для выполнения SQL-запросов.

**Детали:**

Загружает переменные окружения из файла .env, который содержит учетные данные для подключения к базе данных.
Получает параметры подключения, такие как хост, имя базы данных, имя пользователя, пароль и порт.
Устанавливает соединение с базой данных и инициализирует курсор.

**Исключения:**

В случае ошибки подключения к базе данных, метод логирует ошибку и поднимает исключение.

**Пример использования:**

```
db_manager = DatabaseManager()  # Создание экземпляра класса и подключение к базе данных
```

**check_file_exists(filename)**

**Описание:** Проверяет наличие указанного файла в базе данных.

**Параметры:**

- filename (str): Имя файла для проверки.

**Возвращает:**

- bool: True, если файл найден в базе данных; False в противном случае.

**Исключения:**

- Логирует ошибку в случае проблем с выполнением SQL-запроса.

**Пример использования:**

```
file_exists = db_manager.check_file_exists("example_file.txt")
```

**insert_file(filename)**

**Описание:** Добавляет запись о файле в базу данных.

**Параметры:**

- filename (str): Имя файла для вставки.

**Исключения:** 
- Поднимает psycopg2.Error, если произошла ошибка при выполнении SQL-запроса.

**Пример использования:**

```
db_manager.insert_file("example_file.txt")
```

**insert_file_downloaded(filename)**

**Описание:** Вставляет запись о загруженном файле в таблицу archives_of_folders_with_eis_44_Federal_Law.

**Параметры:**

- filename (str): Имя файла для вставки.

**Возвращает:**

- int: Идентификатор вставленной записи или None в случае ошибки.

**Исключения:** 
- Логирует ошибку и выполняет откат транзакции в случае неудачи.

**Пример использования:**

```
file_id = db_manager.insert_file_downloaded("example_archive.zip")
insert_contract_data(archive_id, **kwargs)
```

**def insert_contract_data(self, archive_id, kwargs):**

**Описание:** Вставляет данные о контракте в таблицу contract_data. 
Поля передаются в виде именованных аргументов.

**Параметры:**

- archive_id (int): Идентификатор архива.
- **kwargs: Именованные аргументы, соответствующие полям таблицы contract_data.

**Исключения:** 
- Логирует ошибку и выполняет откат транзакции в случае неудачи.

**Пример использования:**

```
db_manager.insert_contract_data(archive_id=1, purchase_number="12345", contract_value=1000)
```

**insert_archive_file_xml_name(file_id, archive_name)**

**Описание:** Вставляет имя архива в таблицу archives_file_xml_name_eis.

**Параметры:**

- file_id (int): Идентификатор файла.
- archive_name (str): Имя архива для вставки.

**Возвращает:**

- int: Идентификатор вставленной записи или None в случае ошибки.

**Исключения:** 
- Логирует ошибку и выполняет откат транзакции в случае неудачи.

**Пример использования:**

```
new_id = db_manager.insert_archive_file_xml_name(file_id=1, archive_name="my_archive.zip")
```

**get_last_file_id()**

**Описание:** Получает последний идентификатор файла из таблицы archives_of_folders_with_eis_44_Federal_Law.

**Возвращает:**

- int: Идентификатор последнего файла или None, если таблица пуста или произошла ошибка.

**Исключения:**

- Логирует ошибку в случае неудачи.

**Пример использования:**

```
last_file_id = db_manager.get_last_file_id()
```

**get_last_archive_id()**

- def get_last_archive_id(self):

**Описание:** Получает последний идентификатор архива из таблицы archives_file_xml_name_eis.

**Возвращает:**

- int: Идентификатор последнего архива или None, если таблица пуста или произошла ошибка.
- 
**Исключения:**

- Логирует ошибку в случае неудачи.

**Пример использования:**


```
last_archive_id = db_manager.get_last_archive_id()
```

**get_contract_data(data_id)**

- def get_contract_data(self, data_id):

**Описание:** Получает данные контракта по его идентификатору из таблицы contract_data.

**Параметры:**

- data_id (int): Идентификатор данных для запроса.

**Возвращает:**

- dict: Словарь с полями data_id и documentation_links или None, если данные не найдены.

**Исключения:**

- Логирует ошибку в случае неудачи.

**Пример использования:**

```
contract_data = db_manager.get_contract_data(data_id=1)
```

**fetch_contract_data()**

**Описание:** Получает все данные контрактов из таблицы contract_data.

**Возвращает:**

- list: Список всех данных контрактов или пустой список в случае ошибки.

**Исключения:**

- Логирует ошибку в случае неудачи.

**Пример использования:**

```
all_contracts = db_manager.fetch_contract_data()
```

**close()**

**Описание:** Закрывает соединение с базой данных и курсор.

**Пример использования:**
```
db_manager.close()  # Закрывает соединение с базой данных
```

**Применение:**

Класс DatabaseManager используется для управления подключением к базе данных и выполнения операций с данными,
такими как проверка существования файлов, вставка записей и получение данных о контрактах.


>> TO DO -->> закончил на модуле ftp_requests.py нужно продолжить описание дальше

## Разработка

### Настройка среды разработки

Для начала работы над проектом установите следующие инструменты...

### Ветвление и слияние

Мы используем Git Flow для организации нашего процесса разработки. Пожалуйста, создавайте ветки для каждой новой функции...

### Кодекс поведения

Участники проекта должны следовать нашему кодексу поведения, который можно найти здесь...

### Тестирование

Для запуска тестов используйте команду...

### Стиль кодирования

Мы следуем стандартам PEP 8 для Python. Убедитесь, что ваш код соответствует этим стандартам...

### Процесс внесения изменений

Прежде чем отправить запрос на слияние, убедитесь, что ваш код прошел все тесты...

### Документация

Документация является важной частью нашего проекта. Пожалуйста, обновляйте документацию в соответствии с вашими изменениями...

### Инструменты и скрипты

Мы используем следующие инструменты для автоматизации нашего процесса разработки...

## Содействие

Как другие пользователи могут помочь в разработке проекта.

## Лицензия

Информация о лицензии, под которой распространяется проект.

## Авторы

Список тех, кто внес вклад в разработку проекта.

## Благодарности

Благодарности тем, кто помогал в разработке.





# FTPClient

## Описание
`FTPClient` - это Python-класс для работы с FTP-серверами. Он предоставляет функциональность для подключения к серверу, передачи файлов и других операций.

## Использование
1. Установите зависимости:
    ```bash
    pip install -r requirements.txt
    #TODO--> необходимо сделать файл с зависимостями и привязать
    #их к определенным версиям для предотвращения сбоев при работе с
    #программой
    ```

2. Импортируйте класс `FTPClient` в свой код:
    ```python
    from ftp_client import FTPClient
    ```

3. Создайте экземпляр класса, передав параметры подключения:
    ```python
    host = "ftp.example.com"
    username = "myuser"
    password = "mypassword"
    ftp_client = FTPClient(host, username, password)
    ```

4. Выполните необходимые операции:
    - Подключение к серверу:
        ```python
        ftp_client.connect()
        ```

    - Загрузка файла на сервер:
        ```python
        local_file_path = "local_file.txt"
        remote_file_path = "remote_file.txt"
        ftp_client.upload_file(local_file_path, remote_file_path)
        ```

    - Закрытие соединения:
        ```python
        ftp_client.close()
        ```

## Логирование
Логирование событий осуществляется с помощью модуля `logging`. Журнал событий можно настроить в файле `custom_logger.py`.

## Примечание
Не забудьте заменить значения `host`, `username` и `password` на реальные данные для вашего FTP-сервера.

